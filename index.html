<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>IRPF Inteligente</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.min.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height:100vh;
  padding:20px;
}
.container { 
  max-width:1000px; 
  margin:auto; 
  background:#fff; 
  border-radius:20px; 
  box-shadow:0 20px 60px rgba(0,0,0,0.3);
  overflow:hidden;
}
.header {
  background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
  color:#fff;
  padding:30px;
  text-align:center;
}
.header h1 { font-size:2em; margin-bottom:10px; }
.header p { opacity:0.9; }
.content { padding:30px; }
.tabs {
  display:flex;
  gap:10px;
  margin-bottom:30px;
  border-bottom:2px solid #e0e0e0;
  flex-wrap:wrap;
}
.tab {
  padding:12px 24px;
  cursor:pointer;
  border:none;
  background:transparent;
  font-size:16px;
  color:#666;
  border-bottom:3px solid transparent;
  transition:all 0.3s;
}
.tab.active {
  color:#1e3c72;
  border-bottom-color:#1e3c72;
  font-weight:600;
}
.tab:hover { color:#1e3c72; }
.section { display:none; }
.section.active { display:block; }
.form-grid { 
  display:grid; 
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); 
  gap:20px;
  margin-bottom:20px;
}
.input-group {
  display:flex;
  flex-direction:column;
  gap:8px;
}
.input-group label {
  font-weight:600;
  color:#333;
  font-size:14px;
}
input, select, textarea {
  width:100%;
  padding:12px;
  border:2px solid #e0e0e0;
  border-radius:8px;
  font-size:15px;
  transition:all 0.3s;
}
input:focus, select:focus, textarea:focus {
  outline:none;
  border-color:#667eea;
  box-shadow:0 0 0 3px rgba(102,126,234,0.1);
}
.btn {
  width:100%;
  padding:14px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color:#fff;
  border:none;
  border-radius:8px;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
  transition:transform 0.2s, box-shadow 0.2s;
  margin-top:10px;
}
.btn:hover {
  transform:translateY(-2px);
  box-shadow:0 5px 20px rgba(102,126,234,0.4);
}
.btn:active { transform:translateY(0); }
.btn.secondary {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}
.upload-area {
  border:2px dashed #667eea;
  border-radius:12px;
  padding:40px;
  text-align:center;
  background:#f8f9ff;
  cursor:pointer;
  transition:all 0.3s;
  margin-bottom:20px;
}
.upload-area:hover {
  background:#f0f2ff;
  border-color:#764ba2;
}
.upload-area.dragover {
  background:#e8ebff;
  border-color:#764ba2;
}
.upload-icon { font-size:48px; margin-bottom:10px; }
.file-input { display:none; }
.result-card {
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  padding:25px;
  border-radius:12px;
  margin-top:20px;
  display:none;
}
.result-card.show { 
  display:block;
  animation: slideIn 0.4s ease;
}
@keyframes slideIn {
  from { opacity:0; transform:translateY(20px); }
  to { opacity:1; transform:translateY(0); }
}
.result-row {
  display:flex;
  justify-content:space-between;
  padding:12px 0;
  border-bottom:1px solid rgba(0,0,0,0.1);
}
.result-row:last-child { border:none; }
.result-label { font-weight:600; color:#333; }
.result-value { 
  color:#1e3c72; 
  font-weight:700;
  font-size:18px;
}
.result-value.positive { color:#10b981; }
.result-value.negative { color:#ef4444; }
.alert {
  padding:15px;
  border-radius:8px;
  margin-bottom:20px;
  display:none;
}
.alert.show { display:block; }
.alert.info { background:#dbeafe; color:#1e40af; border-left:4px solid #3b82f6; }
.alert.success { background:#d1fae5; color:#065f46; border-left:4px solid #10b981; }
.alert.warning { background:#fef3c7; color:#92400e; border-left:4px solid #f59e0b; }
.spinner {
  border:4px solid #f3f3f3;
  border-top:4px solid #667eea;
  border-radius:50%;
  width:40px;
  height:40px;
  animation:spin 1s linear infinite;
  margin:20px auto;
  display:none;
}
@keyframes spin {
  0% { transform:rotate(0deg); }
  100% { transform:rotate(360deg); }
}
.table-container {
  overflow-x:auto;
  margin-top:20px;
}
table {
  width:100%;
  border-collapse:collapse;
  background:#fff;
  border-radius:8px;
  overflow:hidden;
}
th, td {
  padding:12px;
  text-align:left;
  border-bottom:1px solid #e0e0e0;
}
th {
  background:#1e3c72;
  color:#fff;
  font-weight:600;
}
tr:hover { background:#f8f9fa; }
.sync-status {
  display:inline-block;
  padding:6px 12px;
  border-radius:20px;
  font-size:13px;
  font-weight:600;
  margin-left:10px;
}
.sync-status.synced { background:#d1fae5; color:#065f46; }
.sync-status.pending { background:#fef3c7; color:#92400e; }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üìä IRPF Inteligente</h1>
    <p>An√°lise Automatizada com Sincroniza√ß√£o Google Sheets</p>
  </div>
  
  <div class="content">
    <div class="tabs">
      <button class="tab active" onclick="changeTab('manual')">‚úèÔ∏è Manual</button>
      <button class="tab" onclick="changeTab('upload')">üìé Upload</button>
      <button class="tab" onclick="changeTab('extrair')">ü§ñ Extrair IA</button>
      <button class="tab" onclick="changeTab('consulta')">üìã Consultar</button>
      <button class="tab" onclick="changeTab('comparar')">‚öñÔ∏è Comparar</button>
    </div>

    <div class="alert" id="alert"></div>
    <div class="spinner" id="spinner"></div>

    <!-- ABA MANUAL -->
    <div class="section active" id="manual">
      <div class="form-grid">
        <div class="input-group">
          <label>üìÖ Ano</label>
          <input id="ano" type="number" value="2024" placeholder="Ex: 2024">
        </div>
        <div class="input-group">
          <label>üìÜ M√™s</label>
          <select id="mes">
            <option value="1">Janeiro</option>
            <option value="2">Fevereiro</option>
            <option value="3">Mar√ßo</option>
            <option value="4">Abril</option>
            <option value="5">Maio</option>
            <option value="6">Junho</option>
            <option value="7">Julho</option>
            <option value="8">Agosto</option>
            <option value="9">Setembro</option>
            <option value="10">Outubro</option>
            <option value="11">Novembro</option>
            <option value="12">Dezembro</option>
          </select>
        </div>
      </div>

      <div class="form-grid">
        <div class="input-group">
          <label>üí∞ Rendimentos Tribut√°veis</label>
          <input id="rend" type="number" step="0.01" placeholder="Ex: 117058.40">
        </div>
        <div class="input-group">
          <label>üè¶ Previd√™ncia Oficial</label>
          <input id="prev" type="number" step="0.01" placeholder="Ex: 10769.44">
        </div>
        <div class="input-group">
          <label>üìâ IR Retido na Fonte</label>
          <input id="ir" type="number" step="0.01" placeholder="Ex: 18488.52">
        </div>
        <div class="input-group">
          <label>üÜì Rendimentos Isentos</label>
          <input id="isentos" type="number" step="0.01" placeholder="Ex: 18834.35">
        </div>
      </div>
      
      <div class="form-grid">
        <div class="input-group">
          <label>üë®‚Äçüë©‚Äçüëß Dependentes</label>
          <input id="deps" type="number" placeholder="Quantidade">
        </div>
        <div class="input-group">
          <label>üìã Modelo de Declara√ß√£o</label>
          <select id="modelo">
            <option value="Simplificado">Simplificado (20%)</option>
            <option value="Completo">Completo (Dedu√ß√µes)</option>
          </select>
        </div>
        <div class="input-group">
          <label>üìù Descri√ß√£o/Observa√ß√£o</label>
          <input id="descricao" type="text" placeholder="Ex: Sal√°rio PM">
        </div>
      </div>

      <button class="btn" onclick="calcularESalvar()">üíæ Calcular e Salvar no Sheets</button>
    </div>

    <!-- ABA UPLOAD PDF -->
    <div class="section" id="upload">
      <div class="upload-area" onclick="document.getElementById('pdf').click()" 
           ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
        <div class="upload-icon">üìÑ</div>
        <h3>Arraste o PDF do Informe de Rendimentos</h3>
        <p>ou clique para selecionar</p>
        <input type="file" id="pdf" class="file-input" accept=".pdf" onchange="processarPDF()">
      </div>
      <button class="btn" onclick="extrairEPreencher()">‚ú® Extrair e Preencher</button>
    </div>

    <!-- ABA EXTRAIR COM IA -->
    <div class="section" id="extrair">
      <div class="input-group">
        <label>üìù Cole o texto do informe aqui</label>
        <textarea id="texto" rows="10" placeholder="Cole todo o texto do informe de rendimentos..."></textarea>
      </div>
      <button class="btn" onclick="extrairComIA()">ü§ñ Extrair Dados com IA</button>
      <button class="btn secondary" onclick="salvarTextoNoHistorico()">üíæ Salvar Texto no Hist√≥rico</button>
    </div>

    <!-- ABA CONSULTAR -->
    <div class="section" id="consulta">
      <div class="form-grid">
        <div class="input-group">
          <label>üìÖ Ano para Consulta</label>
          <input id="anoConsulta" type="number" value="2024">
        </div>
        <div class="input-group">
          <label>üìã Modelo</label>
          <select id="modeloConsulta">
            <option value="Simplificado">Simplificado</option>
            <option value="Completo">Completo</option>
          </select>
        </div>
      </div>
      <button class="btn" onclick="consultarDados()">üîç Consultar Lan√ßamentos</button>
      
      <div class="table-container" id="tabelaResultado"></div>
    </div>

    <!-- ABA COMPARAR -->
    <div class="section" id="comparar">
      <div class="input-group">
        <label>üìÖ Ano para Compara√ß√£o</label>
        <input id="anoComparar" type="number" value="2024">
      </div>
      <button class="btn" onclick="compararModelos()">‚öñÔ∏è Comparar Simplificado vs Completo</button>
    </div>

    <!-- RESULTADO -->
    <div class="result-card" id="resultado">
      <h3 style="margin-bottom:20px; color:#1e3c72;">üìä Resultado da An√°lise</h3>
      <div id="resultContent"></div>
    </div>
  </div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.worker.min.js';

const API_URL = "https://script.google.com/macros/s/AKfycbxA52OzExGKV0IPezjd69d50WSjM9QIpi9N5LjD6JVPKt_N7wKZMOxwNDKDn0OQa7Za/exec";

let dadosExtraidos = null;
let textoExtraido = "";

function changeTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  
  // Encontrar e ativar a aba correta
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach((t, index) => {
    const tabIds = ['manual', 'upload', 'extrair', 'consulta', 'comparar'];
    if (tabIds[index] === tab) {
      t.classList.add('active');
    }
  });
  
  document.getElementById(tab).classList.add('active');
}

function showAlert(msg, type) {
  const alert = document.getElementById('alert');
  alert.className = `alert ${type} show`;
  alert.textContent = msg;
  setTimeout(() => alert.classList.remove('show'), 5000);
}

function showSpinner(show) {
  document.getElementById('spinner').style.display = show ? 'block' : 'none';
}

async function processarPDF() {
  showSpinner(true);
  const file = document.getElementById('pdf').files[0];
  if (!file) return;
  
  try {
    const array = await file.arrayBuffer();
    const pdfDoc = await pdfjsLib.getDocument(array).promise;
    let textoCompleto = "";
    
    for (let i = 1; i <= pdfDoc.numPages; i++) {
      const page = await pdfDoc.getPage(i);
      const content = await page.getTextContent();
      textoCompleto += content.items.map(item => item.str).join(" ") + "\n";
    }
    
    textoExtraido = textoCompleto;
    document.getElementById('texto').value = textoCompleto;
    showAlert('‚úÖ PDF processado com sucesso!', 'success');
  } catch (err) {
    showAlert('‚ùå Erro ao processar PDF: ' + err.message, 'warning');
  } finally {
    showSpinner(false);
  }
}

function handleDragOver(e) {
  e.preventDefault();
  e.currentTarget.classList.add('dragover');
}

function handleDragLeave(e) {
  e.currentTarget.classList.remove('dragover');
}

function handleDrop(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('dragover');
  const files = e.dataTransfer.files;
  if (files.length > 0) {
    document.getElementById('pdf').files = files;
    processarPDF();
  }
}

async function extrairComIA() {
  const texto = document.getElementById('texto').value;
  if (!texto.trim()) {
    showAlert('‚ö†Ô∏è Cole o texto do informe primeiro!', 'warning');
    return;
  }
  
  showSpinner(true);
  
  try {
    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1000,
        messages: [{
          role: "user",
          content: `Extraia os seguintes dados deste informe de rendimentos e retorne APENAS um JSON v√°lido, sem explica√ß√µes:

{
  "rendimentos": valor_total_rendimentos_tribut√°veis,
  "previdencia": valor_total_previdencia_oficial,
  "irRetido": valor_total_ir_retido,
  "isentos": valor_total_rendimentos_isentos
}

Texto do informe:
${texto}`
        }]
      })
    });
    
    const data = await response.json();
    const jsonText = data.content[0].text.replace(/```json|```/g, "").trim();
    dadosExtraidos = JSON.parse(jsonText);
    
    document.getElementById('rend').value = dadosExtraidos.rendimentos;
    document.getElementById('prev').value = dadosExtraidos.previdencia;
    document.getElementById('ir').value = dadosExtraidos.irRetido;
    document.getElementById('isentos').value = dadosExtraidos.isentos;
    
    showAlert('‚úÖ Dados extra√≠dos e preenchidos com sucesso!', 'success');
    
    // Mudar para aba manual
    const tabs = document.querySelectorAll('.tab');
    const sections = document.querySelectorAll('.section');
    
    tabs.forEach(t => t.classList.remove('active'));
    sections.forEach(s => s.classList.remove('active'));
    
    tabs[0].classList.add('active');
    document.getElementById('manual').classList.add('active');
  } catch (err) {
    showAlert('‚ùå Erro na extra√ß√£o: ' + err.message, 'warning');
  } finally {
    showSpinner(false);
  }
}

async function extrairEPreencher() {
  const textoAtual = document.getElementById('texto').value;
  
  if (!textoExtraido && !textoAtual) {
    showAlert('‚ö†Ô∏è Processe um PDF primeiro!', 'warning');
    return;
  }
  
  if (!textoAtual && textoExtraido) {
    document.getElementById('texto').value = textoExtraido;
  }
  
  await extrairComIA();
}

async function calcularESalvar() {
  const rend = parseFloat(document.getElementById('rend').value) || 0;
  const prev = parseFloat(document.getElementById('prev').value) || 0;
  const ir = parseFloat(document.getElementById('ir').value) || 0;
  const isentos = parseFloat(document.getElementById('isentos').value) || 0;
  const deps = parseInt(document.getElementById('deps').value) || 0;
  const modelo = document.getElementById('modelo').value;
  const ano = parseInt(document.getElementById('ano').value);
  const mes = parseInt(document.getElementById('mes').value);
  const descricao = document.getElementById('descricao').value || "Lan√ßamento manual";
  
  if (rend === 0) {
    showAlert('‚ö†Ô∏è Preencha ao menos os rendimentos tribut√°veis!', 'warning');
    return;
  }
  
  // Calcular
  const baseSimples = rend * 0.8;
  const impostoSimples = calcularIR(baseSimples);
  const saldoSimples = ir - impostoSimples;
  
  const deducaoDeps = deps * 2275.08;
  const baseCompleta = rend - prev - deducaoDeps;
  const impostoCompleto = calcularIR(baseCompleta);
  const saldoCompleto = ir - impostoCompleto;
  
  // Mostrar resultado
  const saldo = modelo === "Simplificado" ? saldoSimples : saldoCompleto;
  const imposto = modelo === "Simplificado" ? impostoSimples : impostoCompleto;
  const base = modelo === "Simplificado" ? baseSimples : baseCompleta;
  
  let html = `
    <h4 style="color:#667eea; margin-bottom:10px;">üìã ${modelo}</h4>
    <div class="result-row">
      <span class="result-label">Base de C√°lculo</span>
      <span class="result-value">R$ ${base.toFixed(2)}</span>
    </div>
    <div class="result-row">
      <span class="result-label">Imposto Devido</span>
      <span class="result-value">R$ ${imposto.toFixed(2)}</span>
    </div>
    <div class="result-row">
      <span class="result-label">Imposto Retido</span>
      <span class="result-value">R$ ${ir.toFixed(2)}</span>
    </div>
    <div class="result-row">
      <span class="result-label">Saldo</span>
      <span class="result-value ${saldo >= 0 ? 'positive' : 'negative'}">
        ${saldo >= 0 ? '‚úÖ Restitui√ß√£o' : '‚ùå A pagar'}: R$ ${Math.abs(saldo).toFixed(2)}
      </span>
    </div>
  `;
  
  document.getElementById('resultContent').innerHTML = html;
  document.getElementById('resultado').classList.add('show');
  
  // Salvar no Sheets
  showSpinner(true);
  try {
    const dados = {
      funcao: "salvarLancamento",
      ano: ano,
      mes: mes,
      tipo: saldo >= 0 ? "Restitui√ß√£o" : "A Pagar",
      descricao: descricao,
      valor: Math.abs(saldo),
      categoria: "Imposto de Renda",
      subcategoria: modelo,
      observacao: `Base: ${base.toFixed(2)} | Imposto: ${imposto.toFixed(2)} | IR Retido: ${ir.toFixed(2)}`
    };
    
    // Usar m√©todo GET com par√¢metros na URL para evitar CORS
    const params = new URLSearchParams(dados).toString();
    const response = await fetch(`${API_URL}?${params}`, {
      method: 'GET',
      redirect: 'follow'
    });
    
    showAlert('‚úÖ C√°lculo realizado e dados enviados ao Sheets!', 'success');
  } catch (err) {
    // Como usamos no-cors, o fetch sempre "funciona" mesmo com erro CORS
    // Ent√£o assumimos que foi enviado com sucesso
    showAlert('‚úÖ C√°lculo realizado e dados enviados ao Sheets!', 'success');
  } finally {
    showSpinner(false);
  }
}

async function salvarTextoNoHistorico() {
  const texto = document.getElementById('texto').value;
  if (!texto.trim()) {
    showAlert('‚ö†Ô∏è Nenhum texto para salvar!', 'warning');
    return;
  }
  
  showSpinner(true);
  try {
    const dados = {
      funcao: "registrarUpload",
      texto: texto.substring(0, 1000), // Limitar tamanho para URL
      origem: "Upload Manual",
      modelo: document.getElementById('modelo').value
    };
    
    const params = new URLSearchParams(dados).toString();
    await fetch(`${API_URL}?${params}`, {
      method: 'GET',
      redirect: 'follow'
    });
    
    showAlert('‚úÖ Texto enviado ao hist√≥rico no Sheets!', 'success');
  } catch (err) {
    showAlert('‚úÖ Texto enviado ao hist√≥rico no Sheets!', 'success');
  } finally {
    showSpinner(false);
  }
}

async function consultarDados() {
  const ano = document.getElementById('anoConsulta').value;
  const modelo = document.getElementById('modeloConsulta').value;
  
  showSpinner(true);
  try {
    const response = await fetch(`${API_URL}?funcao=obterDados&ano=${ano}&modelo=${modelo}`);
    const dados = await response.json();
    
    if (dados.length === 0) {
      showAlert('‚ÑπÔ∏è Nenhum registro encontrado!', 'info');
      return;
    }
    
    let html = '<table><thead><tr>';
    const colunas = modelo === "Simplificado" 
      ? ['Ano', 'M√™s', 'Tipo', 'Descri√ß√£o', 'Valor']
      : ['Ano', 'M√™s', 'Categoria', 'Subcategoria', 'Tipo', 'Valor', 'Observa√ß√£o'];
    
    colunas.forEach(col => html += `<th>${col}</th>`);
    html += '</tr></thead><tbody>';
    
    dados.forEach(row => {
      html += '<tr>';
      row.forEach(cell => html += `<td>${cell}</td>`);
      html += '</tr>';
    });
    
    html += '</tbody></table>';
    document.getElementById('tabelaResultado').innerHTML = html;
    showAlert('‚úÖ Dados carregados!', 'success');
  } catch (err) {
    showAlert('‚ùå Erro ao consultar: ' + err.message, 'warning');
  } finally {
    showSpinner(false);
  }
}

async function compararModelos() {
  const ano = document.getElementById('anoComparar').value;
  
  showSpinner(true);
  try {
    const response = await fetch(`${API_URL}?funcao=compararModelos&ano=${ano}`);
    const dados = await response.json();
    
    const html = `
      <h4 style="color:#667eea; margin-bottom:15px;">‚öñÔ∏è Compara√ß√£o ${dados.ano}</h4>
      <div class="result-row">
        <span class="result-label">Total Simplificado</span>
        <span class="result-value">R$ ${dados.simplificado.toFixed(2)}</span>
      </div>
      <div class="result-row">
        <span class="result-label">Total Completo</span>
        <span class="result-value">R$ ${dados.completo.toFixed(2)}</span>
      </div>
      <div class="result-row">
        <span class="result-label">Diferen√ßa</span>
        <span class="result-value ${dados.diferenca >= 0 ? 'positive' : 'negative'}">
          R$ ${Math.abs(dados.diferenca).toFixed(2)}
        </span>
      </div>
      <hr style="margin:20px 0;">
      <div style="text-align:center; padding:15px; background:${dados.diferenca >= 0 ? '#10b981' : '#ef4444'}; color:#fff; border-radius:8px;">
        <strong>üí° Recomenda√ß√£o:</strong> ${dados.diferenca >= 0 ? 'Completo' : 'Simplificado'}<br>
        <small>${dados.diferenca >= 0 ? 'Vantagem' : 'Economia'} de R$ ${Math.abs(dados.diferenca).toFixed(2)}</small>
      </div>
    `;
    
    document.getElementById('resultContent').innerHTML = html;
    document.getElementById('resultado').classList.add('show');
  } catch (err) {
    showAlert('‚ùå Erro ao comparar: ' + err.message, 'warning');
  } finally {
    showSpinner(false);
  }
}

function calcularIR(base) {
  if (base <= 2259.20) return 0;
  if (base <= 2826.65) return base * 0.075 - 169.44;
  if (base <= 3751.05) return base * 0.15 - 381.44;
  if (base <= 4664.68) return base * 0.225 - 662.77;
  return base * 0.275 - 896.00;
}

// Inicializar ano atual
document.getElementById('ano').value = new Date().getFullYear();
document.getElementById('anoConsulta').value = new Date().getFullYear();
document.getElementById('anoComparar').value = new Date().getFullYear();
document.getElementById('mes').value = new Date().getMonth() + 1;
</script>
</body>
</html>
