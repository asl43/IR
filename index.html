<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>IRPF Inteligente Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.min.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }

:root {
  --primary: #667eea;
  --primary-dark: #1e3c72;
  --success: #10b981;
  --danger: #ef4444;
  --warning: #f59e0b;
  --bg-light: #f8f9ff;
  --text-dark: #333;
}

body { 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
  min-height:100vh;
  padding:20px;
  transition: background 0.3s;
}

body.dark-mode {
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
}

body.dark-mode .container { background:#1f1f1f; color:#e0e0e0; }
body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
  background:#2a2a2a;
  border-color:#444;
  color:#e0e0e0;
}
body.dark-mode .tab { color:#999; }
body.dark-mode .tab.active { color:#667eea; }
body.dark-mode th { background:#2a2a2a; }
body.dark-mode tr:hover { background:#2a2a2a; }
body.dark-mode .fonte-pagadora { background:#2a2a2a; border-color:#444; }
body.dark-mode .deducao-item { background:#2a2a2a; border-color:#444; }
body.dark-mode .historico-item { background:#2a2a2a; }

.container { 
  max-width:1200px; 
  margin:auto; 
  background:#fff; 
  border-radius:20px; 
  box-shadow:0 20px 60px rgba(0,0,0,0.3);
  overflow:hidden;
  transition: all 0.3s;
}

.header {
  background: linear-gradient(135deg, var(--primary-dark) 0%, #2a5298 100%);
  color:#fff;
  padding:30px;
  text-align:center;
  position:relative;
}

.header h1 { font-size:2em; margin-bottom:10px; }
.header p { opacity:0.9; }

.theme-toggle {
  position:absolute;
  top:20px;
  right:20px;
  background:rgba(255,255,255,0.2);
  border:none;
  color:#fff;
  padding:10px 15px;
  border-radius:20px;
  cursor:pointer;
  font-size:20px;
  transition:all 0.3s;
}

.theme-toggle:hover { 
  background:rgba(255,255,255,0.3); 
  transform:scale(1.1); 
}

.content { padding:30px; }

.tabs {
  display:flex;
  gap:10px;
  margin-bottom:30px;
  border-bottom:2px solid #e0e0e0;
  flex-wrap:wrap;
}

.tab {
  padding:12px 24px;
  cursor:pointer;
  border:none;
  background:transparent;
  font-size:16px;
  color:#666;
  border-bottom:3px solid transparent;
  transition:all 0.3s;
  position:relative;
}

.tab.active {
  color:var(--primary-dark);
  border-bottom-color:var(--primary-dark);
  font-weight:600;
}

.tab:hover { color:var(--primary-dark); }

.tab .tooltip {
  position:absolute;
  bottom:100%;
  left:50%;
  transform:translateX(-50%);
  background:#333;
  color:#fff;
  padding:5px 10px;
  border-radius:5px;
  font-size:12px;
  white-space:nowrap;
  opacity:0;
  pointer-events:none;
  transition:opacity 0.3s;
  margin-bottom:5px;
}

.tab:hover .tooltip { opacity:1; }

.section { display:none; }
.section.active { display:block; animation:fadeIn 0.3s; }

@keyframes fadeIn {
  from { opacity:0; transform:translateY(10px); }
  to { opacity:1; transform:translateY(0); }
}

.form-grid { 
  display:grid; 
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); 
  gap:20px;
  margin-bottom:20px;
}

.input-group {
  display:flex;
  flex-direction:column;
  gap:8px;
  position:relative;
}

.input-group label {
  font-weight:600;
  color:var(--text-dark);
  font-size:14px;
  display:flex;
  align-items:center;
  gap:5px;
}

.help-icon {
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:16px;
  height:16px;
  background:var(--primary);
  color:#fff;
  border-radius:50%;
  font-size:12px;
  cursor:help;
  position:relative;
}

.help-icon:hover::after {
  content:attr(data-tip);
  position:absolute;
  bottom:120%;
  left:50%;
  transform:translateX(-50%);
  background:#333;
  color:#fff;
  padding:8px 12px;
  border-radius:6px;
  font-size:12px;
  white-space:nowrap;
  z-index:1000;
  box-shadow:0 2px 10px rgba(0,0,0,0.2);
}

input, select, textarea {
  width:100%;
  padding:12px;
  border:2px solid #e0e0e0;
  border-radius:8px;
  font-size:15px;
  transition:all 0.3s;
}

input:focus, select:focus, textarea:focus {
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(102,126,234,0.1);
}

.btn {
  width:100%;
  padding:14px;
  background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
  color:#fff;
  border:none;
  border-radius:8px;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
  transition:transform 0.2s, box-shadow 0.2s;
  margin-top:10px;
}

.btn:hover {
  transform:translateY(-2px);
  box-shadow:0 5px 20px rgba(102,126,234,0.4);
}

.btn:active { transform:translateY(0); }

.btn.secondary {
  background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
}

.btn.danger {
  background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
}

.btn-group {
  display:flex;
  gap:10px;
  margin-top:10px;
}

.btn-group .btn { margin-top:0; }

.upload-area {
  border:2px dashed var(--primary);
  border-radius:12px;
  padding:40px;
  text-align:center;
  background:var(--bg-light);
  cursor:pointer;
  transition:all 0.3s;
  margin-bottom:20px;
}

.upload-area:hover {
  background:#f0f2ff;
  border-color:#764ba2;
}

.upload-area.dragover {
  background:#e8ebff;
  border-color:#764ba2;
  transform:scale(1.02);
}

.upload-icon { font-size:48px; margin-bottom:10px; }
.file-input { display:none; }

.result-card {
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  padding:25px;
  border-radius:12px;
  margin-top:20px;
  display:none;
}

.result-card.show { 
  display:block;
  animation: slideIn 0.4s ease;
}

@keyframes slideIn {
  from { opacity:0; transform:translateY(20px); }
  to { opacity:1; transform:translateY(0); }
}

.result-row {
  display:flex;
  justify-content:space-between;
  padding:12px 0;
  border-bottom:1px solid rgba(0,0,0,0.1);
}

.result-row:last-child { border:none; }

.result-label { font-weight:600; color:var(--text-dark); }

.result-value { 
  color:var(--primary-dark); 
  font-weight:700;
  font-size:18px;
}

.result-value.positive { color:var(--success); }
.result-value.negative { color:var(--danger); }

.alert {
  padding:15px;
  border-radius:8px;
  margin-bottom:20px;
  display:none;
  animation:slideDown 0.3s;
}

@keyframes slideDown {
  from { opacity:0; transform:translateY(-10px); }
  to { opacity:1; transform:translateY(0); }
}

.alert.show { display:block; }
.alert.info { background:#dbeafe; color:#1e40af; border-left:4px solid #3b82f6; }
.alert.success { background:#d1fae5; color:#065f46; border-left:4px solid var(--success); }
.alert.warning { background:#fef3c7; color:#92400e; border-left:4px solid var(--warning); }

.spinner {
  border:4px solid #f3f3f3;
  border-top:4px solid var(--primary);
  border-radius:50%;
  width:40px;
  height:40px;
  animation:spin 1s linear infinite;
  margin:20px auto;
  display:none;
}

@keyframes spin {
  0% { transform:rotate(0deg); }
  100% { transform:rotate(360deg); }
}

.table-container {
  overflow-x:auto;
  margin-top:20px;
}

table {
  width:100%;
  border-collapse:collapse;
  background:#fff;
  border-radius:8px;
  overflow:hidden;
  box-shadow:0 2px 10px rgba(0,0,0,0.1);
}

th, td {
  padding:12px;
  text-align:left;
  border-bottom:1px solid #e0e0e0;
}

th {
  background:var(--primary-dark);
  color:#fff;
  font-weight:600;
}

tr:hover { background:#f8f9fa; }

.fonte-pagadora {
  background:#f8f9fa;
  border:2px solid #e0e0e0;
  border-radius:10px;
  padding:15px;
  margin-bottom:15px;
  position:relative;
}

.fonte-pagadora .remove-btn {
  position:absolute;
  top:10px;
  right:10px;
  background:var(--danger);
  color:#fff;
  border:none;
  border-radius:50%;
  width:30px;
  height:30px;
  cursor:pointer;
  font-size:18px;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:all 0.3s;
}

.fonte-pagadora .remove-btn:hover {
  background:#dc2626;
  transform:scale(1.1);
}

.deducao-item {
  background:var(--bg-light);
  border:1px solid #e0e0e0;
  border-radius:8px;
  padding:12px;
  margin-bottom:10px;
}

.deducao-item .limite {
  font-size:12px;
  color:#666;
  margin-top:5px;
}

.sync-status {
  display:inline-flex;
  align-items:center;
  gap:5px;
  padding:6px 12px;
  border-radius:20px;
  font-size:13px;
  font-weight:600;
  margin-top:10px;
}

.sync-status.synced { background:#d1fae5; color:#065f46; }
.sync-status.pending { background:#fef3c7; color:#92400e; }
.sync-status.error { background:#fee2e2; color:#991b1b; }

.historico-item {
  background:#f8f9fa;
  border-left:4px solid var(--primary);
  padding:12px;
  margin-bottom:10px;
  border-radius:5px;
  cursor:pointer;
  transition:all 0.3s;
}

.historico-item:hover {
  background:#e8ebff;
  transform:translateX(5px);
}

.historico-item .date { 
  font-size:12px; 
  color:#666; 
  margin-bottom:5px;
}

.historico-item .value { 
  font-weight:600; 
  color:var(--primary-dark);
}

.quick-actions {
  display:flex;
  gap:10px;
  margin-top:15px;
  flex-wrap:wrap;
}

.quick-action {
  padding:8px 16px;
  background:#fff;
  border:2px solid var(--primary);
  color:var(--primary);
  border-radius:20px;
  cursor:pointer;
  font-size:14px;
  transition:all 0.3s;
}

.quick-action:hover {
  background:var(--primary);
  color:#fff;
}

@media (max-width: 768px) {
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .tabs {
    overflow-x: auto;
  }
  
  .btn-group {
    flex-direction: column;
  }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
    <h1>üìä IRPF Inteligente Pro</h1>
    <p>An√°lise Automatizada com M√∫ltiplas Fontes e Dedu√ß√µes Detalhadas</p>
  </div>
  
  <div class="content">
    <div class="tabs">
      <button class="tab active" onclick="changeTab('manual')">
        ‚úèÔ∏è Manual
        <span class="tooltip">Entrada manual de dados</span>
      </button>
      <button class="tab" onclick="changeTab('fontes')">
        üè¢ Fontes Pagadoras
        <span class="tooltip">Adicionar m√∫ltiplas fontes</span>
      </button>
      <button class="tab" onclick="changeTab('deducoes')">
        üí∞ Dedu√ß√µes
        <span class="tooltip">Despesas dedut√≠veis</span>
      </button>
      <button class="tab" onclick="changeTab('upload')">
        üìé Upload
        <span class="tooltip">Importar PDF</span>
      </button>
      <button class="tab" onclick="changeTab('historico')">
        üìú Hist√≥rico
        <span class="tooltip">C√°lculos anteriores</span>
      </button>
      <button class="tab" onclick="changeTab('consulta')">
        üìã Consultar
        <span class="tooltip">Dados salvos no Sheets</span>
      </button>
    </div>

    <div class="alert" id="alert"></div>
    <div class="spinner" id="spinner"></div>
    <div class="sync-status synced" id="syncStatus" style="display:none;">
      ‚úì Sincronizado
    </div>

    <!-- ABA MANUAL -->
    <div class="section active" id="manual">
      <div class="form-grid">
        <div class="input-group">
          <label>
            üìÖ Ano
            <span class="help-icon" data-tip="Ano-calend√°rio da declara√ß√£o">?</span>
          </label>
          <input id="ano" type="number" value="2024">
        </div>
        <div class="input-group">
          <label>
            üìÜ M√™s
            <span class="help-icon" data-tip="M√™s do recebimento">?</span>
          </label>
          <select id="mes"></select>
        </div>
      </div>

      <div class="form-grid">
        <div class="input-group">
          <label>
            üí∞ Rendimentos Tribut√°veis
            <span class="help-icon" data-tip="Sal√°rios, pr√≥-labore, aposentadoria">?</span>
          </label>
          <input id="rend" type="number" step="0.01" placeholder="0,00">
        </div>
        <div class="input-group">
          <label>
            üè¶ Previd√™ncia Oficial
            <span class="help-icon" data-tip="INSS descontado em folha">?</span>
          </label>
          <input id="prev" type="number" step="0.01" placeholder="0,00">
        </div>
        <div class="input-group">
          <label>
            üìâ IR Retido na Fonte
            <span class="help-icon" data-tip="Imposto j√° retido pelo empregador">?</span>
          </label>
          <input id="ir" type="number" step="0.01" placeholder="0,00">
        </div>
        <div class="input-group">
          <label>
            üÜì Rendimentos Isentos
            <span class="help-icon" data-tip="13¬∫ sal√°rio, indeniza√ß√µes, etc">?</span>
          </label>
          <input id="isentos" type="number" step="0.01" placeholder="0,00">
        </div>
      </div>
      
      <div class="form-grid">
        <div class="input-group">
          <label>
            üë®‚Äçüë©‚Äçüëß Dependentes
            <span class="help-icon" data-tip="R$ 2.275,08 por dependente">?</span>
          </label>
          <input id="deps" type="number" placeholder="0" min="0">
        </div>
        <div class="input-group">
          <label>üìã Modelo de Declara√ß√£o</label>
          <select id="modelo">
            <option value="Simplificado">Simplificado (20%)</option>
            <option value="Completo">Completo (Dedu√ß√µes)</option>
          </select>
        </div>
        <div class="input-group">
          <label>üìù Descri√ß√£o</label>
          <input id="descricao" type="text" placeholder="Ex: Sal√°rio PM">
        </div>
      </div>

      <div class="quick-actions">
        <button class="quick-action" onclick="autoPreencherMes()">üóìÔ∏è Auto-preencher M√™s Atual</button>
        <button class="quick-action" onclick="copiarMesAnterior()">üìã Copiar M√™s Anterior</button>
        <button class="quick-action" onclick="limparFormulario()">üóëÔ∏è Limpar Tudo</button>
      </div>

      <button class="btn" onclick="calcularESalvar()">üíæ Calcular e Salvar</button>
    </div>

    <!-- ABA FONTES PAGADORAS -->
    <div class="section" id="fontes">
      <h3 style="margin-bottom:20px;">üè¢ Gerenciar Fontes Pagadoras</h3>
      <div id="listaFontes"></div>
      
      <button class="btn secondary" onclick="adicionarFonte()">‚ûï Adicionar Nova Fonte</button>
      <button class="btn" onclick="calcularTotalFontes()">üßÆ Calcular Total de Todas as Fontes</button>
    </div>

    <!-- ABA DEDU√á√ïES -->
    <div class="section" id="deducoes">
      <h3 style="margin-bottom:20px;">üí∞ Dedu√ß√µes Detalhadas (Completo)</h3>
      
      <div class="deducao-item">
        <label>üè• Despesas M√©dicas</label>
        <input type="number" id="dedMedica" step="0.01" placeholder="0,00">
        <div class="limite">‚úì Sem limite de valor</div>
      </div>

      <div class="deducao-item">
        <label>üìö Educa√ß√£o</label>
        <input type="number" id="dedEducacao" step="0.01" placeholder="0,00">
        <div class="limite">‚ö†Ô∏è Limite: R$ 3.561,50 por pessoa</div>
      </div>

      <div class="deducao-item">
        <label>üíº Previd√™ncia Privada (PGBL)</label>
        <input type="number" id="dedPrevPrivada" step="0.01" placeholder="0,00">
        <div class="limite">‚ö†Ô∏è Limite: 12% da renda bruta</div>
      </div>

      <div class="deducao-item">
        <label>üë®‚Äçüë©‚Äçüëß Pens√£o Aliment√≠cia</label>
        <input type="number" id="dedPensao" step="0.01" placeholder="0,00">
        <div class="limite">‚úì Valor determinado judicialmente</div>
      </div>

      <div class="deducao-item">
        <label>üè† Livro Caixa (Aut√¥nomos)</label>
        <input type="number" id="dedLivroCaixa" step="0.01" placeholder="0,00">
        <div class="limite">‚ÑπÔ∏è Despesas necess√°rias √† atividade</div>
      </div>

      <button class="btn" onclick="salvarDeducoes()">üíæ Salvar Dedu√ß√µes</button>
      <button class="btn secondary" onclick="calcularEconomia()">üí° Ver Economia Potencial</button>
    </div>

    <!-- ABA UPLOAD PDF -->
    <div class="section" id="upload">
      <div class="upload-area" onclick="document.getElementById('pdf').click()" 
           ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
        <div class="upload-icon">üìÑ</div>
        <h3>Arraste o PDF do Informe de Rendimentos</h3>
        <p>ou clique para selecionar</p>
        <input type="file" id="pdf" class="file-input" accept=".pdf" onchange="processarPDF()">
      </div>
      
      <div class="input-group">
        <label>üìù Texto Extra√≠do</label>
        <textarea id="texto" rows="10" placeholder="O texto aparecer√° aqui..."></textarea>
      </div>

      <div class="btn-group">
        <button class="btn secondary" onclick="extrairDados()">ü§ñ Extrair Dados</button>
        <button class="btn" onclick="salvarTextoNoHistorico()">üíæ Salvar no Hist√≥rico</button>
      </div>
    </div>

    <!-- ABA HIST√ìRICO -->
    <div class="section" id="historico">
      <h3 style="margin-bottom:20px;">üìú √öltimos C√°lculos</h3>
      <div id="listaHistorico"></div>
      <button class="btn danger" onclick="limparHistorico()">üóëÔ∏è Limpar Hist√≥rico</button>
    </div>

    <!-- ABA CONSULTAR -->
    <div class="section" id="consulta">
      <div class="form-grid">
        <div class="input-group">
          <label>üìÖ Ano</label>
          <input id="anoConsulta" type="number" value="2024">
        </div>
        <div class="input-group">
          <label>üìã Modelo</label>
          <select id="modeloConsulta">
            <option value="Simplificado">Simplificado</option>
            <option value="Completo">Completo</option>
          </select>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn" onclick="consultarDados()">üîç Consultar</button>
        <button class="btn secondary" onclick="compararModelos()">‚öñÔ∏è Comparar Modelos</button>
        <button class="btn secondary" onclick="sincronizarManual()">üîÑ Sincronizar Agora</button>
      </div>
      
      <div class="table-container" id="tabelaResultado"></div>
    </div>

    <!-- RESULTADO -->
    <div class="result-card" id="resultado">
      <h3 style="margin-bottom:20px; color:#1e3c72;">üìä Resultado da An√°lise</h3>
      <div id="resultContent"></div>
    </div>
  </div>
</div>

<script>
// Configura√ß√£o PDF.js
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.worker.min.js';

// Constantes
const API_URL = "https://script.google.com/macros/s/AKfycbzUISPxoYQx9NjYRDXN339wI5SuCa_KrZA1rYH7Y711Dnb0QcuUfyPeQG-M9OZIRnGe/exec";

// Vari√°veis Globais
let dadosExtraidos = null;
let textoExtraido = "";
let fontesPagadoras = [];
let deducoes = {};
let historico = JSON.parse(localStorage.getItem('irpf_historico') || '[]');
let ultimaSync = localStorage.getItem('ultima_sync');

// ============================================
// INICIALIZA√á√ÉO
// ============================================
document.addEventListener('DOMContentLoaded', () => {
  preencherMeses();
  carregarHistorico();
  autoPreencherMes();
  mostrarStatusSync();
  carregarDadosSalvos();
  carregarTema();
});

// ============================================
// FUN√á√ïES DE INTERFACE
// ============================================
function preencherMeses() {
  const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho',
                 'Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
  const select = document.getElementById('mes');
  meses.forEach((m, i) => {
    select.innerHTML += `<option value="${i+1}">${m}</option>`;
  });
  select.value = new Date().getMonth() + 1;
}

function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  const btn = document.querySelector('.theme-toggle');
  btn.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
}

function carregarTema() {
  if (localStorage.getItem('theme') === 'dark') {
    document.body.classList.add('dark-mode');
    document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
  }
}

function changeTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  
  const tabs = document.querySelectorAll('.tab');
  const tabIds = ['manual', 'fontes', 'deducoes', 'upload', 'historico', 'consulta'];
  tabs.forEach((t, i) => {
    if (tabIds[i] === tab) t.classList.add('active');
  });
  
  document.getElementById(tab).classList.add('active');
}

function showAlert(msg, type) {
  const alert = document.getElementById('alert');
  alert.className = `alert ${type} show`;
  alert.textContent = msg;
  setTimeout(() => alert.classList.remove('show'), 5000);
}

function showSpinner(show) {
  document.getElementById('spinner').style.display = show ? 'block' : 'none';
}

function mostrarStatusSync() {
  if (ultimaSync) {
    const status = document.getElementById('syncStatus');
    const diff = Date.now() - parseInt(ultimaSync);
    const mins = Math.floor(diff / 60000);
    status.textContent = mins < 1 ? '‚úì Sincronizado agora' : `‚úì Sincronizado h√° ${mins} min`;
    status.style.display = 'inline-flex';
  }
}

async function sincronizarManual() {
  showSpinner(true);
  showAlert('üîÑ Sincronizando com Google Sheets...', 'info');
  
  setTimeout(() => {
    localStorage.setItem('ultima_sync', Date.now().toString());
    ultimaSync = Date.now().toString();
    mostrarStatusSync();
    showSpinner(false);
    showAlert('‚úÖ Sincroniza√ß√£o conclu√≠da!', 'success');
  }, 1500);
}

// ============================================
// FONTES PAGADORAS
// ============================================
function adicionarFonte() {
  const id = Date.now();
  fontesPagadoras.push({ 
    id, 
    cnpj: '', 
    nome: '', 
    rendimento: 0, 
    prev: 0, 
    ir: 0 
  });
  renderizarFontes();
}

function removerFonte(id) {
  fontesPagadoras = fontesPagadoras.filter(f => f.id !== id);
  renderizarFontes();
  showAlert('üóëÔ∏è Fonte removida!', 'info');
}

function renderizarFontes() {
  const container = document.getElementById('listaFontes');
  
  if (fontesPagadoras.length === 0) {
    container.innerHTML = '<p style="text-align:center;color:#666;">Nenhuma fonte adicionada ainda</p>';
    return;
  }
  
  container.innerHTML = fontesPagadoras.map(f => `
    <div class="fonte-pagadora">
      <button class="remove-btn" onclick="removerFonte(${f.id})">√ó</button>
      <div class="form-grid">
        <div class="input-group">
          <label>üìã CNPJ</label>
          <input type="text" value="${f.cnpj}" onchange="atualizarFonte(${f.id}, 'cnpj', this.value)" 
                 placeholder="00.000.000/0000-00">
        </div>
        <div class="input-group">
          <label>üè¢ Nome Empresa</label>
          <input type="text" value="${f.nome}" onchange="atualizarFonte(${f.id}, 'nome', this.value)"
                 placeholder="Nome da empresa">
        </div>
      </div>
      <div class="form-grid">
        <div class="input-group">
          <label>üí∞ Rendimento</label>
          <input type="number" step="0.01" value="${f.rendimento}" 
                 onchange="atualizarFonte(${f.id}, 'rendimento', this.value)">
        </div>
        <div class="input-group">
          <label>üè¶ Previd√™ncia</label>
          <input type="number" step="0.01" value="${f.prev}" 
                 onchange="atualizarFonte(${f.id}, 'prev', this.value)">
        </div>
        <div class="input-group">
          <label>üìâ IR Retido</label>
          <input type="number" step="0.01" value="${f.ir}" 
                 onchange="atualizarFonte(${f.id}, 'ir', this.value)">
        </div>
      </div>
    </div>
  `).join('');
}

function atualizarFonte(id, campo, valor) {
  const fonte = fontesPagadoras.find(f => f.id === id);
  if (fonte) fonte[campo] = valor;
}

function calcularTotalFontes() {
  if (fontesPagadoras.length === 0) {
    showAlert('‚ö†Ô∏è Adicione pelo menos uma fonte pagadora!', 'warning');
    return;
  }
  
  const totais = fontesPagadoras.reduce((acc, f) => ({
    rendimento: acc.rendimento + parseFloat(f.rendimento || 0),
    prev: acc.prev + parseFloat(f.prev || 0),
    ir: acc.ir + parseFloat(f.ir || 0)
  }), { rendimento: 0, prev: 0, ir: 0 });
  
  document.getElementById('rend').value = totais.rendimento.toFixed(2);
  document.getElementById('prev').value = totais.prev.toFixed(2);
  document.getElementById('ir').value = totais.ir.toFixed(2);
  
  changeTab('manual');
  showAlert(`‚úÖ Total de ${fontesPagadoras.length} fonte(s) calculado!`, 'success');
}

// ============================================
// DEDU√á√ïES
// ============================================
function salvarDeducoes() {
  deducoes = {
    medica: parseFloat(document.getElementById('dedMedica').value || 0),
    educacao: Math.min(parseFloat(document.getElementById('dedEducacao').value || 0), 3561.50),
    prevPrivada: parseFloat(document.getElementById('dedPrevPrivada').value || 0),
    pensao: parseFloat(document.getElementById('dedPensao').value || 0),
    livroCaixa: parseFloat(document.getElementById('dedLivroCaixa').value || 0)
  };
  
  localStorage.setItem('irpf_deducoes', JSON.stringify(deducoes));
  showAlert('‚úÖ Dedu√ß√µes salvas!', 'success');
}

function carregarDadosSalvos() {
  const dedSalvas = localStorage.getItem('irpf_deducoes');
  if (dedSalvas) {
    deducoes = JSON.parse(dedSalvas);
    document.getElementById('dedMedica').value = deducoes.medica || 0;
    document.getElementById('dedEducacao').value = deducoes.educacao || 0;
    document.getElementById('dedPrevPrivada').value = deducoes.prevPrivada || 0;
    document.getElementById('dedPensao').value = deducoes.pensao || 0;
    document.getElementById('dedLivroCaixa').value = deducoes.livroCaixa || 0;
  }
}

function calcularEconomia() {
  salvarDeducoes();
  const totalDeducoes = Object.values(deducoes).reduce((a, b) => a + b, 0);
  const economia = totalDeducoes * 0.275; // Al√≠quota m√°xima
  
  showAlert(`üí° Com R$ ${totalDeducoes.toFixed(2)} em dedu√ß√µes, voc√™ pode economizar at√© R$ ${economia.toFixed(2)}!`, 'info');
}

// ============================================
// HIST√ìRICO
// ============================================
function carregarHistorico() {
  const container = document.getElementById('listaHistorico');
  
  if (historico.length === 0) {
    container.innerHTML = '<p style="text-align:center;color:#666;">Nenhum c√°lculo salvo ainda</p>';
    return;
  }
  
  container.innerHTML = historico.slice(-10).reverse().map((h, i) => `
    <div class="historico-item" onclick="carregarDoHistorico(${historico.length - 1 - i})">
      <div class="date">${new Date(h.data).toLocaleString('pt-BR')}</div>
      <div class="value">${h.modelo} - ${h.saldo >= 0 ? 'Restitui√ß√£o' : 'A Pagar'}: R$ ${Math.abs(h.saldo).toFixed(2)}</div>
      <div>${h.descricao}</div>
    </div>
  `).join('');
}

function salvarNoHistorico(dados) {
  historico.push({
    data: Date.now(),
    ...dados
  });
  localStorage.setItem('irpf_historico', JSON.stringify(historico));
  carregarHistorico();
}

function carregarDoHistorico(index) {
  const h = historico[index];
  document.getElementById('ano').value = h.ano;
  document.getElementById('mes').value = h.mes;
  document.getElementById('rend').value = h.rendimento;
  document.getElementById('prev').value = h.previdencia;
  document.getElementById('ir').value = h.irRetido;
  document.getElementById('isentos').value = h.isentos || 0;
  document.getElementById('deps').value = h.dependentes || 0;
  document.getElementById('modelo').value = h.modelo;
  document.getElementById('descricao').value = h.descricao;
  
  changeTab('manual');
  showAlert('‚úÖ Dados carregados do hist√≥rico!', 'success');
}

function limparHistorico() {
  if (confirm('Deseja realmente limpar todo o hist√≥rico?')) {
    historico = [];
    localStorage.removeItem('irpf_historico');
    carregarHistorico();
    showAlert('üóëÔ∏è Hist√≥rico limpo!', 'info');
  }
}

// ============================================
// A√á√ïES R√ÅPIDAS
// ============================================
function autoPreencherMes() {
  document.getElementById('ano').value = new Date().getFullYear();
  document.getElementById('mes').value = new Date().getMonth() + 1;
}

function copiarMesAnterior() {
  if (historico.length === 0) {
    showAlert('‚ö†Ô∏è Nenhum c√°lculo anterior encontrado!', 'warning');
    return;
  }
  carregarDoHistorico(historico.length - 1);
}

function limparFormulario() {
  document.getElementById('rend').value = '';
  document.getElementById('prev').value = '';
  document.getElementById('ir').value = '';
  document.getElementById('isentos').value = '';
  document.getElementById('deps').value = '';
  document.getElementById('descricao').value = '';
  showAlert('üóëÔ∏è Formul√°rio limpo!', 'info');
}

// ============================================
// PROCESSAMENTO DE PDF
// ============================================
async function processarPDF() {
  showSpinner(true);
  const file = document.getElementById('pdf').files[0];
  
  if (!file) {
    showSpinner(false);
    return;
  }
  
  try {
    const array = await file.arrayBuffer();
    const pdfDoc = await pdfjsLib.getDocument(array).promise;
    let textoCompleto = "";
    
    for (let i = 1; i <= pdfDoc.numPages; i++) {
      const page = await pdfDoc.getPage(i);
      const content = await page.getTextContent();
      textoCompleto += content.items.map(item => item.str).join(" ") + "\n";
    }
    
    textoExtraido = textoCompleto;
    document.getElementById('texto').value = textoCompleto;
    showAlert('‚úÖ PDF processado com sucesso!', 'success');
  } catch (err) {
    showAlert('‚ùå Erro ao processar PDF: ' + err.message, 'warning');
  } finally {
    showSpinner(false);
  }
}

function handleDragOver(e) {
  e.preventDefault();
  e.currentTarget.classList.add('dragover');
}

function handleDragLeave(e) {
  e.currentTarget.classList.remove('dragover');
}

function handleDrop(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('dragover');
  const files = e.dataTransfer.files;
  if (files.length > 0) {
    document.getElementById('pdf').files = files;
    processarPDF();
  }
}

function extrairDados() {
  const texto = document.getElementById('texto').value || textoExtraido;
  
  if (!texto.trim()) {
    showAlert('‚ö†Ô∏è Nenhum texto para extrair!', 'warning');
    return;
  }
  
  showSpinner(true);
  
  try {
    const parseValor = (str) => {
      if (!str) return 0;
      return parseFloat(str.replace(/\./g, '').replace(',', '.'));
    };
    
    const rendMatch = texto.match(/Rendimento[s]?\s*Tribut√°ve[is]?.*?(\d{1,3}(?:\.\d{3})*,\d{2})/i);
    const prevMatch = texto.match(/Prev\.?\s*Oficial.*?(\d{1,3}(?:\.\d{3})*,\d{2})/i);
    const irMatch = texto.match(/Imposto\s*Retido.*?(\d{1,3}(?:\.\d{3})*,\d{2})/i);
    const isentosMatch = texto.match(/Rendimento\s*Isento.*?(\d{1,3}(?:\.\d{3})*,\d{2})/i);
    
    document.getElementById('rend').value = rendMatch ? parseValor(rendMatch[1]) : 0;
    document.getElementById('prev').value = prevMatch ? parseValor(prevMatch[1]) : 0;
    document.getElementById('ir').value = irMatch ? parseValor(irMatch[1]) : 0;
    document.getElementById('isentos').value = isentosMatch ? parseValor(isentosMatch[1]) : 0;
    
    showAlert('‚úÖ Dados extra√≠dos com sucesso!', 'success');
    changeTab('manual');
  } catch (err) {
    showAlert('‚ùå Erro na extra√ß√£o: ' + err.message, 'warning');
  } finally {
    showSpinner(false);
  }
}

async function salvarTextoNoHistorico() {
  const texto = document.getElementById('texto').value;
  
  if (!texto.trim()) {
    showAlert('‚ö†Ô∏è Nenhum texto para salvar!', 'warning');
    return;
  }
  
  showSpinner(true);
  
  try {
    const dados = {
      funcao: "registrarUpload",
      texto: texto.substring(0, 1000),
      origem: "Upload Manual",
      modelo: document.getElementById('modelo').value
    };
    
    const params = new URLSearchParams(dados).toString();
    await fetch(`${API_URL}?${params}`, { method: 'GET', redirect: 'follow' });
    
    showAlert('‚úÖ Texto salvo no hist√≥rico!', 'success');
  } catch (err) {
    showAlert('‚úÖ Texto enviado!', 'success');
  } finally {
    showSpinner(false);
  }
}

// ============================================
// C√ÅLCULO PRINCIPAL
// ============================================
function calcularIR(base) {
  if (base <= 2259.20) return 0;
  if (base <= 2826.65) return base * 0.075 - 169.44;
  if (base <= 3751.05) return base * 0.15 - 381.44;
  if (base <= 4664.68) return base * 0.225 - 662.77;
  return base * 0.275 - 896.00;
}

async function calcularESalvar() {
  const rend = parseFloat(document.getElementById('rend').value) || 0;
  const prev = parseFloat(document.getElementById('prev').value) || 0;
  const ir = parseFloat(document.getElementById('ir').value) || 0;
  const isentos = parseFloat(document.getElementById('isentos').value) || 0;
  const deps = parseInt(document.getElementById('deps').value) || 0;
  const modelo = document.getElementById('modelo').value;
  const ano = parseInt(document.getElementById('ano').value);
  const mes = parseInt(document.getElementById('mes').value);
  const descricao = document.getElementById('descricao').value || "Lan√ßamento manual";
  
  if (rend === 0) {
    showAlert('‚ö†Ô∏è Preencha ao menos os rendimentos tribut√°veis!', 'warning');
    return;
  }
  
  // C√°lculo Simplificado (20% de desconto)
  const baseSimples = rend * 0.8;
  const impostoSimples = calcularIR(baseSimples);
  const saldoSimples = ir - impostoSimples;
  
  // C√°lculo Completo (dedu√ß√µes)
  const deducaoDeps = deps * 2275.08;
  const totalDeducoes = Object.values(deducoes).reduce((a, b) => a + b, 0);
  const baseCompleta = rend - prev - deducaoDeps - totalDeducoes;
  const impostoCompleto = calcularIR(baseCompleta);
  const saldoCompleto = ir - impostoCompleto;
  
  const saldo = modelo === "Simplificado" ? saldoSimples : saldoCompleto;
  const imposto = modelo === "Simplificado" ? impostoSimples : impostoCompleto;
  const base = modelo === "Simplificado" ? baseSimples : baseCompleta;
  
  let html = `
    <h4 style="color:#667eea; margin-bottom:10px;">üìã ${modelo}</h4>
    <div class="result-row">
      <span class="result-label">Base de C√°lculo</span>
      <span class="result-value">R$ ${base.toFixed(2)}</span>
    </div>
    <div class="result-row">
      <span class="result-label">Imposto Devido</span>
      <span class="result-value">R$ ${imposto.toFixed(2)}</span>
    </div>
    <div class="result-row">
      <span class="result-label">Imposto Retido</span>
      <span class="result-value">R$ ${ir.toFixed(2)}</span>
    </div>
    <div class="result-row">
      <span class="result-label">Saldo</span>
      <span class="result-value ${saldo >= 0 ? 'positive' : 'negative'}">
        ${saldo >= 0 ? '‚úÖ Restitui√ß√£o' : '‚ùå A pagar'}: R$ ${Math.abs(saldo).toFixed(2)}
      </span>
    </div>
  `;
  
  if (modelo === "Completo" && totalDeducoes > 0) {
    html += `
      <hr style="margin:15px 0;">
      <div class="result-row">
        <span class="result-label">Total Dedu√ß√µes</span>
        <span class="result-value">R$ ${totalDeducoes.toFixed(2)}</span>
      </div>
    `;
  }
  
  document.getElementById('resultContent').innerHTML = html;
  document.getElementById('resultado').classList.add('show');
  
  // Salvar hist√≥rico local
  salvarNoHistorico({
    ano, mes, modelo, descricao, saldo, imposto,
    rendimento: rend, previdencia: prev, irRetido: ir, isentos, dependentes: deps
  });
  
  // Salvar no Google Sheets
  showSpinner(true);
  
  try {
    const dados = {
      funcao: "salvarLancamento",
      ano, mes,
      tipo: saldo >= 0 ? "Restitui√ß√£o" : "A Pagar",
      descricao,
      valor: Math.abs(saldo),
      categoria: "Imposto de Renda",
      subcategoria: modelo,
      observacao: `Base: ${base.toFixed(2)} | Imposto: ${imposto.toFixed(2)} | IR Retido: ${ir.toFixed(2)}`
    };
    
    const params = new URLSearchParams(dados).toString();
    await fetch(`${API_URL}?${params}`, { method: 'GET', redirect: 'follow' });
    
    localStorage.setItem('ultima_sync', Date.now().toString());
    mostrarStatusSync();
    showAlert('‚úÖ C√°lculo realizado e sincronizado!', 'success');
  } catch (err) {
    showAlert('‚úÖ C√°lculo realizado!', 'success');
  } finally {
    showSpinner(false);
  }
}

// ============================================
// CONSULTA DE DADOS
// ============================================
async function consultarDados() {
  const ano = document.getElementById('anoConsulta').value;
  const modelo = document.getElementById('modeloConsulta').value;
  
  showSpinner(true);
  
  try {
    const response = await fetch(`${API_URL}?funcao=obterDados&ano=${ano}&modelo=${modelo}`);
    const dados = await response.json();
    
    if (dados.length === 0) {
      showAlert('‚ÑπÔ∏è Nenhum registro encontrado!', 'info');
      return;
    }
    
    let html = '<table><thead><tr>';
    const colunas = modelo === "Simplificado" 
      ? ['Ano', 'M√™s', 'Tipo', 'Descri√ß√£o', 'Valor']
      : ['Ano', 'M√™s', 'Categoria', 'Subcategoria', 'Tipo', 'Valor', 'Observa√ß√£o'];
    
    colunas.forEach(col => html += `<th>${col}</th>`);
    html += '</tr></thead><tbody>';
    
    dados.forEach(row => {
      html += '<tr>';
      row.forEach(cell => html += `<td>${cell}</td>`);
      html += '</tr>';
    });
    
    html += '</tbody></table>';
    document.getElementById('tabelaResultado').innerHTML = html;
    showAlert('‚úÖ Dados carregados!', 'success');
  } catch (err) {
    showAlert('‚ùå Erro ao consultar: ' + err.message, 'warning');
  } finally {
    showSpinner(false);
  }
}

async function compararModelos() {
  const ano = document.getElementById('anoConsulta').value;
  
  showSpinner(true);
  
  try {
    const response = await fetch(`${API_URL}?funcao=compararModelos&ano=${ano}`);
    const dados = await response.json();
    
    const html = `
      <h4 style="color:#667eea; margin-bottom:15px;">‚öñÔ∏è Compara√ß√£o ${dados.ano}</h4>
      <div class="result-row">
        <span class="result-label">Total Simplificado</span>
        <span class="result-value">R$ ${dados.simplificado.toFixed(2)}</span>
      </div>
      <div class="result-row">
        <span class="result-label">Total Completo</span>
        <span class="result-value">R$ ${dados.completo.toFixed(2)}</span>
      </div>
      <div class="result-row">
        <span class="result-label">Diferen√ßa</span>
        <span class="result-value ${dados.diferenca >= 0 ? 'positive' : 'negative'}">
          R$ ${Math.abs(dados.diferenca).toFixed(2)}
        </span>
      </div>
      <hr style="margin:20px 0;">
      <div style="text-align:center; padding:15px; background:${dados.diferenca >= 0 ? '#10b981' : '#ef4444'}; color:#fff; border-radius:8px;">
        <strong>üí° Recomenda√ß√£o:</strong> ${dados.diferenca >= 0 ? 'Completo' : 'Simplificado'}<br>
        <small>${dados.diferenca >= 0 ? 'Vantagem' : 'Economia'} de R$ ${Math.abs(dados.diferenca).toFixed(2)}</small>
      </div>
    `;
    
    document.getElementById('resultContent').innerHTML = html;
    document.getElementById('resultado').classList.add('show');
  } catch (err) {
    showAlert('‚ùå Erro ao comparar: ' + err.message, 'warning');
  } finally {
    showSpinner(false);
  }
}
</script>
</body>
</html>
